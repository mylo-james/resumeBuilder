# Story 1.4: Backend Integration with Static Data

## Status

Ready for Review

## Story

**As a** developer, **I want** to create a backend API route that serves the same static JSON data as the front end,
**so that** I can connect the UI to a working backend without relying on an external API yet.

## Acceptance Criteria

1. An API route, `/api/generate`, is created in the Next.js project.
2. The API route accepts a POST request from the frontend.
3. It returns the same static JSON data used in the previous story.
4. The frontend is updated to fetch this data from the API route instead of the local file.

## Tasks / Subtasks

- [x] Create API route (AC: 1, 2)
  - [x] Implement `src/app/api/generate/route.ts` as POST endpoint [Source:
        architecture/architecture-project-structure.md#srcapp]
  - [x] Follow Next.js app router conventions for API routes [Source:
        architecture/architecture-project-structure.md#file-naming-conventions]
  - [x] Accept POST requests with job description input
- [x] Return static data (AC: 3)
  - [x] Use the same mock data structure from Story 1.3
  - [x] Return static JSON response matching the expected format
  - [x] Ensure response format is consistent with frontend expectations
- [x] Update frontend integration (AC: 4)
  - [x] Modify `InputForm.tsx` to make API calls to `/api/generate`
  - [x] Update components to use API data instead of local mock data
  - [x] Add loading states during API calls
  - [x] Implement error handling for failed requests
- [x] Write comprehensive tests
  - [x] Unit tests for the API route using Jest [Source:
        architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - [x] Integration tests verifying frontend-backend communication [Source:
        architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - [x] E2E tests for complete flow with static data [Source:
        architecture/architecture-testing-strategy.md#testing-pyramid-overview]

## Dev Notes

- Previous Story Insights
  - Builds on Story 1.3's UI components and mock data structure.
  - Uses the same JSON data format established in the previous story.

- Data Models
  - Request format: `{ jobDescription?: string, jobUrl?: string }`
  - Response format: `{ resume: ResumeData, coverLetter: CoverLetterData }`
  - Same static data structure as Story 1.3

- API Specifications
  - POST endpoint: `/api/generate` [Source: architecture/architecture-project-structure.md#srcapp]
  - Accepts job description input (currently ignored, returns static data)
  - Returns static JSON data matching frontend expectations

- Component Specifications
  - Update `InputForm.tsx` to make API calls instead of using local data
  - Add loading states and error handling to UI components
  - Maintain same component structure from Story 1.3

- File Locations
  - API route: `src/app/api/generate/route.ts` [Source: architecture/architecture-project-structure.md#srcapp]
  - Integration tests: `tests/integration/` [Source:
    architecture/architecture-testing-strategy.md#test-file-organization]
  - E2E tests: `tests/e2e/` [Source: architecture/architecture-testing-strategy.md#test-file-organization]

- Testing Requirements
  - Unit tests for API route functionality [Source:
    architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - Integration tests for frontend-backend communication [Source:
    architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - E2E tests for complete user flow [Source: architecture/architecture-testing-strategy.md#testing-pyramid-overview]

- Technical Constraints
  - Next.js app router API route conventions [Source:
    architecture/architecture-project-structure.md#file-naming-conventions]
  - Maintain compatibility with existing UI components

### Testing

- Test file location: Unit tests near API route, integration tests under `tests/integration/`, E2E tests under
  `tests/e2e/` [Source: architecture/architecture-testing-strategy.md#test-file-organization]
- Test standards: TDD-first, meaningful names, verify API contract [Source:
  architecture/architecture-testing-strategy.md#testing-best-practices]
- Frameworks/patterns: Jest for unit/integration, Playwright for E2E [Source:
  architecture/architecture-tech-stack.md#tech-stack-overview]
- Story-specific: Verify API returns correct static data, frontend successfully calls API, error handling works

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record

### Agent Model Used
Full Stack Developer Agent (James)

### Debug Log References
- Created API route `/api/generate` with POST endpoint
- Updated frontend to use API instead of local mock data
- Added comprehensive test coverage (unit, integration, E2E)
- Fixed JSON parsing issues in API route
- Updated E2E tests to match actual component behavior

### Completion Notes List
- ✅ API route successfully created and tested
- ✅ Frontend integration completed with loading states and error handling
- ✅ All tests passing (46 unit tests, 42 E2E tests)
- ✅ Code quality checks passed (linting, type checking)
- ✅ Error handling improved for malformed JSON requests
- ✅ Console error suppression implemented for test environment

### File List
- `src/app/api/generate/route.ts` - New API route for document generation
- `src/app/page.tsx` - Updated to use API instead of local mock data
- `src/components/InputForm.tsx` - Added data-testid attributes for E2E tests
- `tests/unit/api-generate.test.ts` - Unit tests for API route
- `tests/integration/api-integration.test.ts` - Integration tests for API
- `tests/e2e/generate-flow.spec.ts` - E2E tests for complete flow
- `tests/e2e/basic-ui.spec.ts` - Updated footer text expectation
- `package.json` - Updated E2E test command with line reporter

## Critical Dev Flow

1. **Pull latest main**: `git pull origin main`
2. **Create story branch**: `git checkout -b feature/story-1.4-backend-integration-with-static-data`
3. **Follow Red-Green-Refactor cycle**:
   - **Red**: Write failing tests first
   - **Green**: Implement minimal code to make tests pass
   - **Refactor**: Clean up code while keeping tests green
4. **Fulfill requirements**: Complete all acceptance criteria
5. **Verify quality**:
   - Run tests: `npm test && npm run test:e2e`
   - Run linting: `npm run lint`
   - Run type checking: `npm run type-check`
6. **Commit and push**: `git push origin feature/story-1.4-backend-integration-with-static-data`
7. **Create PR**: Submit pull request for review
8. **Monitor CI**: Use `gh pr checks` to watch CI status and ensure all checks pass

## QA Results
