# Story 1.8: Local PDF Storage

## Status

Draft

## Story

**As a** developer, **I want** the backend to store a copy of generated PDFs locally, **so that** we have a record of
all generated documents.

## Acceptance Criteria

1. A local storage directory is created for PDF files.
2. Each generated PDF is saved with a unique filename.
3. The backend returns both the JSON data and the PDF file path.
4. Error handling is implemented for storage failures.

## Tasks / Subtasks

- [ ] Create storage service (AC: 1, 2)
  - [ ] Implement `src/lib/services/storage.ts` PDF storage service [Source:
        architecture/architecture-project-structure.md#srclib]
  - [ ] Create `src/lib/utils/file-utils.ts` for file system utilities [Source:
        architecture/architecture-project-structure.md#srclib]
  - [ ] Create `src/lib/utils/filename-generator.ts` for unique filename generation [Source:
        architecture/architecture-project-structure.md#srclib]
  - [ ] Create unique filenames using timestamp and hash
- [ ] Implement file management (AC: 2, 3)
  - [ ] Implement file size limits and validation
  - [ ] Add automatic cleanup for old files
  - [ ] Handle storage directory creation and permissions
  - [ ] Update API response to include file metadata
- [ ] Update API route (AC: 3)
  - [ ] Modify `/api/generate` to save PDFs locally
  - [ ] Add file metadata to response
  - [ ] Implement file retrieval endpoint if needed
- [ ] Implement error handling (AC: 4)
  - [ ] Handle disk space issues, permission errors, file system failures
  - [ ] Handle invalid file operations and storage quota exceeded
  - [ ] Provide appropriate error responses
- [ ] Write comprehensive tests
  - [ ] Unit tests for storage service [Source: architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - [ ] Integration tests for file system operations [Source:
        architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - [ ] E2E tests for file storage operations [Source:
        architecture/architecture-testing-strategy.md#testing-pyramid-overview]

## Dev Notes

- Previous Story Insights
  - Builds on Story 1.7's PDF generation capabilities.
  - Adds server-side storage to client-side PDF generation.

- Data Models
  - Storage configuration:
    `{ basePath: string, maxFileSize: number, allowedExtensions: string[], cleanupInterval: number }`
  - Stored file metadata:
    `{ filename: string, path: string, size: number, createdAt: Date, metadata: { jobDescription: string, generatedAt: Date } }`
  - API response format including file path and metadata

- API Specifications
  - POST endpoint: `/api/generate` (updated from Story 1.7) [Source:
    architecture/architecture-project-structure.md#srcapp]
  - Optional file retrieval endpoint for stored PDFs
  - Enhanced response format with file metadata

- Component Specifications
  - Maintain existing UI components from previous stories
  - Add optional file management UI if needed
  - Error handling for storage-related failures

- File Locations
  - Storage service: `src/lib/services/storage.ts` [Source: architecture/architecture-project-structure.md#srclib]
  - File utilities: `src/lib/utils/file-utils.ts` [Source: architecture/architecture-project-structure.md#srclib]
  - Filename generator: `src/lib/utils/filename-generator.ts` [Source:
    architecture/architecture-project-structure.md#srclib]
  - Updated API route: `src/app/api/generate/route.ts` [Source: architecture/architecture-project-structure.md#srcapp]

- Testing Requirements
  - Test file system operations with mocked file system [Source:
    architecture/architecture-testing-strategy.md#testing-best-practices]
  - Test error scenarios for storage failures [Source:
    architecture/architecture-testing-strategy.md#testing-pyramid-overview]
  - Verify file metadata and cleanup operations [Source:
    architecture/architecture-testing-strategy.md#testing-pyramid-overview]

- Technical Constraints
  - File system permissions and security considerations
  - Storage quota management and cleanup
  - Unique filename generation to prevent conflicts

### Testing

- Test file location: Unit tests near services, integration tests under `tests/integration/`, E2E tests under
  `tests/e2e/` [Source: architecture/architecture-testing-strategy.md#test-file-organization]
- Test standards: Mock file system, test error scenarios, verify file operations [Source:
  architecture/architecture-testing-strategy.md#testing-best-practices]
- Frameworks/patterns: Jest for unit/integration with mocked file system, Playwright for E2E [Source:
  architecture/architecture-tech-stack.md#tech-stack-overview]
- Story-specific: Test file storage, unique naming, metadata handling, error scenarios for storage failures

## Change Log

| Date | Version | Description | Author |
| ---- | ------- | ----------- | ------ |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## Critical Dev Flow

1. **Pull latest main**: `git pull origin main`
2. **Create story branch**: `git checkout -b feature/story-1.8-local-pdf-storage`
3. **Follow Red-Green-Refactor cycle**:
   - **Red**: Write failing tests first
   - **Green**: Implement minimal code to make tests pass
   - **Refactor**: Clean up code while keeping tests green
4. **Fulfill requirements**: Complete all acceptance criteria
5. **Verify quality**:
   - Run tests: `npm test && npm run test:e2e`
   - Run linting: `npm run lint`
   - Run type checking: `npm run type-check`
6. **Commit and push**: `git push origin feature/story-1.8-local-pdf-storage`
7. **Create PR**: Submit pull request for review
8. **Monitor CI**: Use `gh pr checks` to watch CI status and ensure all checks pass

## QA Results
